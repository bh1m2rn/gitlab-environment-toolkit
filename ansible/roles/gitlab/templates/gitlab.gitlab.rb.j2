# Single Node
external_url '{{ external_url| regex_replace("\\/$", "") }}'
registry_external_url '{{ external_url| regex_replace("\\/$", "") }}:4567'

{% if gitlab_rails_webserver == 'puma' %}
unicorn['enable'] = false
puma['enable'] = true

puma['worker_processes'] = {{ gitlab_rails_puma_workers }}
puma['max_threads'] = {{ gitlab_rails_puma_threads }}
puma['listen'] = '0.0.0.0'
{% elif gitlab_rails_webserver == 'unicorn' %} 
unicorn['enable'] = true
puma['enable'] = false

unicorn['worker_processes'] = {{ gitlab_rails_unicorn_workers }}
unicorn['listen'] = '0.0.0.0'
{% endif %}

gitlab_rails['gitlab_default_projects_features_builds'] = false

# Database Settings
gitlab_rails['initial_root_password'] = '5iveL!fe'

# Ensure UIDs and GIDs match between servers for permissions via NFS
nginx['enable'] = true
nginx['status']['options'] = {
  "server_tokens" => "off",
  "access_log" => "off",
  "allow" => "{{ monitor_int_ip }}",
  "deny" => "all",
}

# Storage Config
# Object Storage
gitlab_rails['artifacts_object_store_enabled'] = true
gitlab_rails['artifacts_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['artifacts_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

gitlab_rails['lfs_object_store_enabled'] = true
gitlab_rails['lfs_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['lfs_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

gitlab_rails['uploads_object_store_enabled'] = true
gitlab_rails['uploads_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['uploads_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

gitlab_rails['external_diffs_enabled'] = true
gitlab_rails['external_diffs_object_store_enabled'] = true
gitlab_rails['external_diffs_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['external_diffs_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

gitlab_rails['packages_object_store_enabled'] = true
gitlab_rails['packages_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['packages_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

gitlab_rails['dependency_proxy_object_store_enabled'] = true
gitlab_rails['dependency_proxy_object_store_remote_directory'] = "{{ gitlab_object_storage }}"
gitlab_rails['dependency_proxy_object_store_connection'] = {
  'provider' => 'Google',
  'google_project' => '{{ project_name }}',
  'google_json_key_location' => '{{ serviceaccount_path }}'
}

registry['storage'] = {
  'gcs' => {
    'bucket' => '{{ gitlab_object_storage }}'
  }
}

# Monitor
prometheus['listen_address'] = ':9090'
grafana['admin_password'] = '5iveL!fe'
grafana['disable_login_form'] = false
grafana['env'] = {
  'GF_AUTH_ANONYMOUS_ENABLED' => true,
  'GF_SERVER_ROOT_URL' => '{{ external_url| regex_replace("\\/$", "") }}/-/grafana'
}

node_exporter['listen_address'] = '0.0.0.0:9100'
gitlab_rails['monitoring_whitelist'] = ['0.0.0.0/0']
gitlab_workhorse['prometheus_listen_addr'] = '0.0.0.0:9229'
