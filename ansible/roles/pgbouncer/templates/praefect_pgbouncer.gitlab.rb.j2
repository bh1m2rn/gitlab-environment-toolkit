# Disable all components except Pgbouncer and Consul agent
roles ['pgbouncer_role']

# Configure Pgbouncer

{% if groups['praefect_postgres'] | length > 1 %}
pgbouncer['users'] = {
  'gitlab-consul': {
    password: "{{ ((consul_database_password | default(consul_password)) + 'gitlab-consul') | md5 }}"
  },
  'pgbouncer': {
    password: "{{ (praefect_pgbouncer_password + 'pgbouncer') | md5 }}"
  }
}

pgbouncer['databases'] = {
  praefect_production: {},
  praefect_production_direct: {
    dbname: '{{ praefect_postgres_database_name }}',
    pool_mode: 'session'
  }
}

{% else %}
pgbouncer['admin_users'] = %w(pgbouncer gitlab-consul)
pgbouncer['databases'] = {
  praefect_production: {
    host: '{{ praefect_postgres_host }}',
    user: 'pgbouncer',
    password: "{{ (praefect_pgbouncer_password + 'pgbouncer') | md5 }}"
  },
  praefect_production_direct: {
    host: '{{ postgres_host }}',
    user: 'pgbouncer',,
    password: "{{ (praefect_pgbouncer_password + 'pgbouncer') | md5 }}",
    dbname: '{{ praefect_postgres_database_name }}',
    pool_mode: 'session'
  }
}
{% endif %}

pgbouncer['listen_port'] = '{{ praefect_pgbouncer_port }}'
pgbouncer['max_db_connections'] = 150

# Configure Consul agent
{% if groups['postgres'] | length > 1 %}
consul['watchers'] = %w(postgresql)
consul['internal']['postgresql_service_name'] = 'praefect_postgresql'
patroni['scope'] = 'praefect-postgresql-ha'
{% endif %}
consul['configuration'] = {
  bind_addr: '{{ ansible_default_ipv4.address }}',
  retry_join: %w({{ (consul_int_ips if 'consul' in groups else gitlab_rails_int_ips) | join(' ') }})
}
consul['monitoring_service_discovery'] = true

node_exporter['listen_address'] = '0.0.0.0:9100'

pgbouncer_exporter['enable'] = true
pgbouncer_exporter['listen_address'] = '0.0.0.0:9188'

custom_confs = Dir.glob(File.join("/etc/gitlab/", "gitlab.pgbouncer.*.rb"))
custom_confs.each { |conf|
  from_file conf
}
