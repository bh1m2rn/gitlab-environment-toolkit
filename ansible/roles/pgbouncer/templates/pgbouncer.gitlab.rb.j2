# Disable all components except Pgbouncer and Consul agent
roles ['pgbouncer_role']

# Configure Pgbouncer
pgbouncer['admin_users'] = %w(pgbouncer gitlab-consul)

# Configure Consul agent
consul['watchers'] = %w(postgresql)

pgbouncer['users'] = {
  'gitlab-consul': {
    password: '{{ consul_password }}'
  },
  'pgbouncer': {
    password: '{{ pgbouncer_password }}'
  }
}

consul['configuration'] = {
  retry_join: %w({{ consul_internal_ips | join(' ') }})
}

node_exporter['listen_address'] = '0.0.0.0:9100'
