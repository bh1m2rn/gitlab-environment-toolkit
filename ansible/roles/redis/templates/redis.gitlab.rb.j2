roles ['{{ "redis_master_role" if (group_names | select("match", ".*_primary") | list | count > 0) else "redis_slave_role" }}', 'redis_sentinel_role']

redis['bind'] = '0.0.0.0'
redis['port'] = 6379
redis['password'] = '{{ redis_password }}'
redis['master_ip'] = '{{ redis_cache_primary_ip if (group_names | select("match", ".*_cache_.*") | list | count > 0) else redis_persistent_primary_ip }}'
redis['master_name'] = '{{ "gitlab-redis-cache" if (group_names | select("match", ".*_cache_.*") | list | count > 0) else "gitlab-redis-persistent" }}'
redis['master_password'] = '{{ redis_password }}'

{% if (group_names | select("match", ".*_cache_.*") | list | count > 0) %}
redis['maxmemory'] = '{{ ((ansible_memory_mb.real.total | int) * 0.9) | int }}mb'
redis['maxmemory_policy'] = "allkeys-lru"
redis['maxmemory_samples'] = 5
{% endif %}

sentinel['bind'] = '0.0.0.0'
sentinel['quorum'] = 2

gitlab_rails['auto_migrate'] = false

consul['enable'] = true
consul['configuration'] = {
  retry_join: %w({{ consul_internal_ips | join(' ') }}),
  bind_addr: '{{ ansible_default_ipv4.address }}'
}
consul['monitoring_service_discovery'] =  true

node_exporter['listen_address'] = '0.0.0.0:9100'
redis_exporter['listen_address'] = '0.0.0.0:9121'
redis_exporter['flags'] = {
  'redis.addr' => "redis://localhost:6379",
  'redis.password' => '{{ redis_password }}'
}
